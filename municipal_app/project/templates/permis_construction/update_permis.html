{% extends "_base.html" %}
{% block content %}

{% if accept %}
<div id='accept_panel' class="panel panel-default animated fadeInUp go">
	<div class="panel-heading clearfix">
		<h3 class="panel-title"> قبول رخصة  {{ name }}</h3>
		<ul class="panel-tool-options"> 
			<li><a data-rel="collapse" href="#"><i class="icon-down-open"></i></a></li>
			<li><a data-rel="reload" href="#"><i class="icon-arrows-ccw"></i></a></li>
		</ul>
	</div>
	<div class="panel-body">
		<div class='row'>
			<form action="/update_permisconst/accept" method="POST">
				<div class="row">
					<div class="col-md-6">عدد قرار رخصة البناء * 
						<input type="number" class="form-control" placeholder="" name='num_permis' value=''>							
					</div>
				</div>
				<div class="row">
					<div class="col-md-6">تاريخ اسناد الرخصة *
						<div id="date-popup2" class="input-group date">
							<input type="text" class="form-control" placeholder="" name='date_attribution' id='date_attribution' value='' onchange="submitExpiration()">
							<span class="input-group-addon"><i class="fa fa-calendar"></i></span>
						</div>							
					</div>
					<div class="col-md-6">تاريخ انتهاء الصلوحيّة *
						<div id="date-popup2" class="input-group date">
							<input type="text" class="form-control" placeholder="" name='date_expiration' id='date_expiration' value='' readonly>
							<span class="input-group-addon"><i class="fa fa-calendar"></i></span>
						</div>							
					</div>
				</div>
				<div class="row">
					<div class="col-md-6">المساحة 
						<input type="text" class="form-control" placeholder="" name='surface' value='{{permis_data.surface}}' readonly>							
					</div>
				</div>
				<div class='row'>
					<div class="col-md-6">
						<div class="form-group-inner">معلوم التسييج أو الترميم (25000 مليم)
							<div class="col-sm-offset-2 col-sm-10"> 
								<div class="radio"> <label> <input type="radio" onchange='submitTotal()' value="25000" id="optionsradios1" name="optionsradios">نعم</label> </div> 
								<div class="radio"> <label> <input type="radio" value="0" id="optionsradios2" onchange='submitTotal_min()' name="optionsradios">لا</label></div>
							</div>
						</div>
					</div>
				</div>
				<div class="row">
					<div class="col-md-6">
						<div class="form-group-inner"> المبلغ الجملي بالمليم
							<input type="number" class="form-control" placeholder="" id='mont_total' name='mont_total' value='{{montant_total}}' readonly>
							<input type="hidden" class="form-control" placeholder="" id='mont_total2' name='mont_total2' value='{{montant_total}}' readonly>
						</div>
					</div>
				</div>
				<div class='row'>
					<div class="form-group">
						<div class="col-sm-10"></div>
						<div class="col-sm-1">
							<button class="btn btn-primary" type="submit">حفظ</button>
							<input type="hidden" name="type" value='{{permis_id}}'>
							<input type="hidden" name="name" value="{{name}}">
						</div>
						<div class="col-sm-1">
							<a href='/consult_permisconst' class="btn btn-red" type="submit">إلغاء</a>
						</div>
					</div>
				</div>
			</form>
		</div>

	</div>
</div>
{% elif refuse %}
<div id='refuse_panel' class="panel panel-default animated fadeInUp go">
	<div class="panel-heading clearfix">
		<h3 class="panel-title"> رفض رخصة  {{ name }}</h3>
		<ul class="panel-tool-options"> 
			<li><a data-rel="collapse" href="#"><i class="icon-down-open"></i></a></li>
			<li><a data-rel="reload" href="#"><i class="icon-arrows-ccw"></i></a></li>
		</ul>
	</div>
	<div class="panel-body">
		<div class='row'>
			<form action="/update_permisconst/refuse" method="POST">
				<div class="row">
					<div class="col-md-6">تاريخ الرفض *
						<div id="date-popup2" class="input-group date">
							<input type="text" class="form-control" placeholder="" name='date_refuse' value='' >
							<span class="input-group-addon"><i class="fa fa-calendar"></i></span>
						</div>							
					</div>
					<div class="col-md-6">ملاحظات
						<div class="form-group-inner">
							<textarea type="textarea" class="form-control" placeholder="" name='refuse_note' id="refuse_note" >
							</textarea>
						</div>
					</div>
				</div>
				<div class="row">
					<div class="form-group">
						<div class="col-sm-10"></div>
						<div class="col-sm-1">
							<button class="btn btn-primary" type="submit">حفظ</button>
							<input type="hidden" name="type" value='{{permis_id}}'>
							<input type="hidden" name="name" value="{{name}}">
						</div>
						<div class="col-sm-1">
							<a href='/consult_permisconst' class="btn btn-red" type="submit">إلغاء</a>
						</div>
					</div>
				</div> 
			</form>
		</div>

	</div>
</div>
{% else %}
<div id='maj_panel' class="panel panel-default animated fadeInUp go">
	<div class="panel-heading clearfix">
		<h3 class="panel-title"> تحيين رخصة  {{ name }}</h3>
		<ul class="panel-tool-options"> 
			<li><a data-rel="collapse" href="#"><i class="icon-down-open"></i></a></li>
			<li><a data-rel="reload" href="#"><i class="icon-arrows-ccw"></i></a></li>
		</ul>
	</div>
	<div class="panel-body">
		<div class='row'>
			<div class='col-md-2'></div>
			<div class='col-md-2'></div>
			<div class='col-md-2'></div>
			<div class='col-md-2'>
				<input class="btn btn-info btn-outline" name='button' id="btnEdit" type="submit" value= 'تحيين الرخصة'>
			</div>
			<div class='col-md-2'>
				<form action="/update_permisconst/accept" method="POST"> 
					<input href='/update_permisconst/accept' id='btnEditaccept' class="btn btn-success btn-outline" name='button' type="submit" value= 'قبول الرخصة'>
					<input type="hidden" name="type" value="{{permis_id}}">
					<input type="hidden" name="name" value="{{name}}">
				</form> 
			</div>
			<div class='col-md-2'>
				<form action="/update_permisconst/refuse" method="POST">
					<input id='btnEditrefuse' class="btn btn-red btn-outline" type='submit' name='button' value='رفض الرخصة'>
					<input type="hidden" name="type" value="{{permis_id}}">
					<input type="hidden" name="name" value="{{name}}">
				</form>
			</div>
		</div>
		<ul class="nav nav-tabs" style="float: left;"> 
			<li class="active"><a data-toggle="tab" href="#tab-1" aria-expanded="true">data</a></li> 
			<li><a data-toggle="tab" href="#tab-2" aria-expanded="false">geo</a></li> 
		</ul>
		<div class='row'>
			<form action="/update_permisconst" method="POST">
				<div class="form-group">
					<div class="tab-content">
						<div id="tab-1" class="tab-pane active">
							<div class="row">
								<div class="col-md-3">تاريخ إيداع المطلب
									<div id="date-popup" class="input-group date">
										<input type="text" class="form-control" placeholder="" name='date_depot' value='{{permis_data.date_depot}}' id ="maj" readonly>
										<span class="input-group-addon"><i class="fa fa-calendar"></i></span>
									</div>							
								</div>
								<div class="col-md-3">رقم المطلب<div class="form-group-inner"><input type="text" class="form-control" placeholder="" name='num_demande' value='{{permis_data.num_demande}}' id ="maj" readonly></div></div>
								<div class="col-md-3">رقم بطاقة التعريف أو بطاقة الاقامة <div class="form-group-inner"><input type="text" class="form-control" placeholder="" id ="maj" value='{{permis_data.num_cin}}' readonly></div></div>
								<div class="col-md-3">العنوان<div class="form-group-inner"><input type="text" class="form-control" placeholder="" name='address' value='{{permis_data.address}}' id ="maj" readonly></div></div>
							</div>                    
							<div class="row">
								<div class="col-md-3">نوع البناء<div class="form-group-inner"><input type="text" class="form-control" name='type_construct' placeholder="" value='{{permis_data.type_construct}}' id ="maj" readonly></div></div>
								<div class="col-md-3">المساحة<div class="form-group-inner"><input type="text" class="form-control" placeholder="" name='surface' value='{{permis_data.surface}}' id ="maj" readonly></div></div>
								<div class="col-md-3">إسم و لقب صاحب الرخصة<div class="form-group-inner"><input type="text" class="form-control"  placeholder="" name='nom_titulaire' value='{{permis_data.nom_titulaire}}' id ="maj" readonly></div></div>					
								<div class="col-md-3">وصف الأشغال<div class="form-group"><textarea type="textarea" class="form-control"  name='desc_construct' value='{{permis_data.desc_construct}}' id ="maj" readonly>{{permis_data.desc_construct}}</textarea></div></div>
							</div>
							{% if permis_data.permis_status == 'approved' %}
							<div class="row">
								<div class="col-md-3">تاريخ اسناد الرخصة
									<div id="date-popup2" class="input-group date">
										<input type="text" class="form-control" placeholder="" name='date_attribution' value='{{permis_data.date_attribution}}' id ="maj" readonly>
										<span class="input-group-addon"><i class="fa fa-calendar"></i></span>
									</div>							
								</div>
								<div class="col-md-3">تاريخ انتهاء الصلوحيّة
									<div id="date-popup" class="input-group date">
										<input type="text" class="form-control" placeholder="" name='date_expiration' value='{{permis_data.date_expiration}}' id ="date_expiration" readonly>
										<span class="input-group-addon"><i class="fa fa-calendar"></i></span>
									</div>							
								</div>
								<div class="col-md-3">عدد قرار رخصة البناء
									<div class="form-group-inner">
										<input type="number" class="form-control" placeholder="" name='num_permis' value='{{permis_data.num_permis}}' id ="maj" readonly>
									</div>
								</div>
								<div class="col-md-3">المبلغ الجملي بالمليم
									<div class="form-group-inner">
										<input type="text" class="form-control" placeholder="" name='mont_total' value='{{permis_data.mont_total}}' id ="maj" readonly>
									</div>
								</div>
							</div>
							{% endif %}
						</div>
						<div id="tab-2" class="tab-pane">   
							<div class="row">
								<div class='col-md-4'>
									<div class='row'>
										<div class="col-md-12">longitude<div class="form-group-inner"><input type="text" class="form-control" placeholder="" name='longitude' value='{{permis_data.longitude}}' id ="longitude" readonly></div></div>
									</div>
									<div class='row'>
										<div class="col-md-12">laltitude<div class="form-group-inner"><input type="text" class="form-control" placeholder="" name='laltitude' value='{{permis_data.laltitude}}' id ="laltitude" readonly></div></div>
									</div>
								</div>
								<div class='col-md-8'>
									<div id="mapid" style="width: 500px; height: 500px; position: relative; outline: none;" class="leaflet-container leaflet-touch leaflet-fade-anim leaflet-grab leaflet-touch-drag leaflet-touch-zoom" tabindex="0">
										<div class="leaflet-pane leaflet-map-pane" style="transform: translate3d(87px, 44px, 0px);">
											<div class="leaflet-pane leaflet-tile-pane">
												<div class="leaflet-layer " style="z-index: 1; opacity: 1;"><div class="leaflet-tile-container leaflet-zoom-animated" style="z-index: 18; transform: translate3d(0px, 0px, 0px) scale(1);"></div></div></div><div class="leaflet-pane leaflet-shadow-pane"></div><div class="leaflet-pane leaflet-overlay-pane"></div><div class="leaflet-pane leaflet-marker-pane"></div><div class="leaflet-pane leaflet-tooltip-pane"></div><div class="leaflet-pane leaflet-popup-pane"></div><div class="leaflet-proxy leaflet-zoom-animated" style="transform: translate3d(1.04796e+06px, 697335px, 0px) scale(4096);"></div></div><div class="leaflet-control-container"><div class="leaflet-top leaflet-left"><div class="leaflet-control-zoom leaflet-bar leaflet-control"><a class="leaflet-control-zoom-in" href="#" title="Zoom in" role="button" aria-label="Zoom in">+</a><a class="leaflet-control-zoom-out" href="#" title="Zoom out" role="button" aria-label="Zoom out">−</a></div></div><div class="leaflet-top leaflet-right"></div><div class="leaflet-bottom leaflet-left"></div><div class="leaflet-bottom leaflet-right"><div class="leaflet-control-attribution leaflet-control"><a href="http://leafletjs.com" title="A JS library for interactive maps">Leaflet</a> | Map data © <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, <a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, Imagery © <a href="http://mapbox.com">Mapbox</a></div></div></div></div>
											</div>
										</div>
										<div class='row'>
											<div class="form-group animated fadeInUp go" id='save_encours' style="display:none">
												<div class="col-sm-10"></div>
												<div class="col-sm-1">
													<button class="btn btn-primary btn-block" type="submit">حفظ</button>
													<input type="hidden" name="type" value='{{permis_id}}'>
													<input type="hidden" name="name" value="{{name}}">
												</div>
												<div class="col-sm-1">
													<a href='/consult_permisconst' class="btn btn-red btn-block" type="submit">إلغاء</a>
												</div>
											</div>
										</div>
									</div>
					</div>
				</div>
			</form>
		</div>
	</div>
</div>
			{% endif %}
			{% block js %}
			<script>
			function submitTotal() {
				var Total = document.getElementById('mont_total2').value;
				var siege = document.getElementById('optionsradios1').value;
				var Total2 = (Number(Total) + Number(siege)).toString();
				$("#mont_total").val(Total2)
			}
			function submitTotal_min() {
				var Total2 = document.getElementById('mont_total2').value;
				$("#mont_total").val(Total2)
			}

			function submitExpiration() {
				var Dattr = document.getElementById('date_attribution').value;
				if( /^\d{4}\/\d{2}\/\d{2}$/i.test( Dattr ) ) {

					var parts = Dattr.split("/");

					var day = parts[2] && parseInt( parts[2], 10 );
					var month = parts[1] && parseInt( parts[1], 10 );
					var year = parts[0] && parseInt( parts[0], 10 );
					var duration = 3;

					if( day <= 31 && day >= 1 && month <= 12 && month >= 1 ) {

						var expiryDate = new Date( year, month - 1, day );
						expiryDate.setFullYear( expiryDate.getFullYear() + duration );

						var day = ( '0' + expiryDate.getDate() ).slice( -2 );
						var month = ( '0' + ( expiryDate.getMonth() + 1 ) ).slice( -2 );
						var year = expiryDate.getFullYear();

						$("#date_expiration").val( year + "/" + month + "/" + day);

					} else {
        // display error message
    }
}
};

$(document).ready(function()
{
	$('#btnEdit').click(function()
	{
		$("input[id='maj']").removeAttr("readonly")
		$("textarea[id='maj']").removeAttr("readonly")
		$("div[id=save_encours]").removeAttr('style')
		$('#btnEdit').css({
			'display': 'none',
		});
		$('#btnEditaccept').css({
			'display': 'none',
		});
		$('#btnEditrefuse').css({
			'display': 'none',
		}); 
	});

});

{% if not refuse and not accept %}
var mymap = L.map('mapid').setView([{{permis_data.laltitude}},{{permis_data.longitude}}], 15);
L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
	maxZoom: 18,
	attribution: 'Map data &copy; <a href="http://openstreetmap.org">OpenStreetMap</a> contributors, ' +
	'<a href="http://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
	'Imagery © <a href="http://mapbox.com">Mapbox</a>',
	id: 'mapbox.streets'
}).addTo(mymap);

L.marker([{{permis_data.laltitude}},{{permis_data.longitude}}]).addTo(mymap)
.bindPopup("<b>رخصة  {{ name }}</b><br />").openPopup();
var popup = L.popup();

function onMapClick(e) {
	document.getElementById('laltitude').value = e.latlng.lat.toString();
	document.getElementById('longitude').value = e.latlng.lng.toString();
	popup
	.setLatLng(e.latlng)
	.setContent("<i class='fa fa-map-marker'/>" + e.latlng.toString())
	.openOn(mymap);
}

mymap.on('click', onMapClick);

$(document).ready(function()
{
	$('#accept_buttom').click(function()
	{
		$('#btnEdit').css({
			'display': 'none',
		})
		$('#refuse_buttom').css({
			'display': 'none',
		});
		$('#maj_panel').css({
			'display': 'none',
		});
		$('#accept_panel').removeAttr('style')


	});

});
{% endif %}
$(document).ready(function () {
	$('#date-popup2').datepicker({
		keyboardNavigation: false,
		forceParse: false,
		todayHighlight: true,
		format: "yyyy/mm/dd"
	});

	$('#date-popup').datepicker({
		keyboardNavigation: false,
		forceParse: false,
		todayHighlight: true,
		format: "yyyy/mm/dd"
	});



	var dragFixed = document.getElementById('drag-fixed');
	noUiSlider.create(dragFixed, {
		start: [40, 60],
		behaviour: 'drag-fixed',
		connect: true,
		range: {
			'min': 20,
			'max': 80
		}
	});

	var basicSlider = document.getElementById('basic-slider');
	noUiSlider.create(basicSlider, {
		start: 40,
		behaviour: 'tap',
		connect: 'upper',
		range: {
			'min': 20,
			'max': 80
		}
	});

	var rangeSlider = document.getElementById('range-slider');
	noUiSlider.create(rangeSlider, {
		start: [40, 60],
		behaviour: 'drag',
		connect: true,
		range: {
			'min': 20,
			'max': 80
		}
	});

	$(".select2").select2();
	$(".select2-placeholer").select2({
		allowClear: true
	});

//$('.colorpicker').colorpicker();

// Colorpicker
if ($.isFunction($.fn.colorpicker))
{
	$(".colorpicker").each(function (i, el)
	{
		var $this = $(el);
		var  opts = {
//format: attrDefault($this, 'format', false)
};
var $nextEle = $this.next();
var $prevEle = $this.prev();
var $colorPreview = $this.siblings('.input-group-addon').find('.icon-color-preview');

$this.colorpicker(opts);

if ($nextEle.is('.input-group-addon') && $nextEle.has('span'))
{
	$nextEle.on('click', function (ev)
	{
		ev.preventDefault();
		$this.colorpicker('show');
	});
}

if ($prevEle.is('.input-group-addon') && $prevEle.has('span'))
{
	$prevEle.on('click', function (ev)
	{
		ev.preventDefault();
		$this.colorpicker('show');
	});
}

if ($colorPreview.length)
{
	$this.on('changeColor', function (ev) {

		$colorPreview.css('background-color', ev.color.toHex());
	});

	if ($this.val())
	{
		$colorPreview.css('background-color', $this.val());
	}
}
});
}
});
</script>
{% endblock %}
{% endblock %}